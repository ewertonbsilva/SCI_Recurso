<!DOCTYPE html>
<html>
<head>
    <title>Teste Novas Features - SP, TR, VW</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; max-height: 300px; }
        .result { margin-top: 10px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    </style>
</head>
<body>
    <h1>üöÄ Teste Novas Features - SP, TR, VW</h1>
    
    <div class="grid">
        <div class="test-section">
            <h2>1. Stored Procedures</h2>
            <button onclick="testGerarId('turno')">Gerar ID Turno</button>
            <button onclick="testGerarId('civil')">Gerar ID Civil</button>
            <button onclick="testGerarId('atestado')">Gerar ID Atestado</button>
            <button onclick="testCriarTurnoSP()">Criar Turno com SP</button>
            <button onclick="testDashboard()">Dashboard Completo</button>
            <button onclick="testDisponibilidade()">Verificar Disponibilidade</button>
            <div id="sp-results" class="result"></div>
        </div>

        <div class="test-section">
            <h2>2. Views Otimizadas</h2>
            <button onclick="testEfetivoDisponivel()">Efetivo Dispon√≠vel</button>
            <button onclick="testResumoTurnos()">Resumo de Turnos</button>
            <button onclick="testLogsRecentes()">Logs Recentes</button>
            <button onclick="testMilitaresRestricoes()">Militares com Restri√ß√µes</button>
            <div id="vw-results" class="result"></div>
        </div>
    </div>

    <div class="test-section">
        <h2>3. Teste de Integra√ß√£o</h2>
        <button onclick="testCriarCivilComSP()">Criar Civil (ID via SP)</button>
        <button onclick="testCriarAtestadoComSP()">Criar Atestado (ID via SP)</button>
        <button onclick="testTriggerAuditoria()">Testar Trigger de Auditoria</button>
        <div id="integration-results" class="result"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001/api';

        // Stored Procedures Tests
        async function testGerarId(tipo) {
            const resultDiv = document.getElementById('sp-results');
            resultDiv.innerHTML = `<p>Gerando ID para ${tipo}...</p>`;
            
            try {
                const response = await fetch(`${API_BASE}/sp/gerar-id/${tipo}`);
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h3>‚úÖ ID Gerado - ${tipo}</h3>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    throw new Error(data.error || 'Erro desconhecido');
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h3>‚ùå Erro ao gerar ID</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function testCriarTurnoSP() {
            const resultDiv = document.getElementById('sp-results');
            resultDiv.innerHTML = '<p>Criando turno com SP...</p>';
            
            try {
                // Gerar data futura para evitar duplicatas
                const futureDate = new Date();
                futureDate.setDate(futureDate.getDate() + Math.floor(Math.random() * 30) + 1);
                const dataStr = futureDate.toISOString().split('T')[0];
                const periodos = ['Manh√£', 'Tarde', 'Noite'];
                const periodo = periodos[Math.floor(Math.random() * periodos.length)];
                
                const response = await fetch(`${API_BASE}/turnos-com-sp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        data: dataStr, 
                        periodo: periodo 
                    })
                });
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h3>‚úÖ Turno Criado com SP</h3>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    throw new Error(data.error || 'Erro desconhecido');
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h3>‚ùå Erro ao criar turno</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function testDashboard() {
            const resultDiv = document.getElementById('sp-results');
            resultDiv.innerHTML = '<p>Buscando dashboard...</p>';
            
            try {
                const response = await fetch(`${API_BASE}/dashboard`);
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h3>‚úÖ Dashboard Completo</h3>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    throw new Error(data.error || 'Erro desconhecido');
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h3>‚ùå Erro ao buscar dashboard</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function testDisponibilidade() {
            const resultDiv = document.getElementById('sp-results');
            resultDiv.innerHTML = '<p>Verificando disponibilidade...</p>';
            
            try {
                const today = new Date().toISOString().split('T')[0];
                const response = await fetch(`${API_BASE}/disponibilidade?data=${today}&periodo=Manh√£`);
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h3>‚úÖ Disponibilidade - ${today} Manh√£</h3>
                            <p><strong>Total dispon√≠vel:</strong> ${data.length} pessoas</p>
                            <details>
                                <summary>Ver detalhes</summary>
                                <pre>${JSON.stringify(data, null, 2)}</pre>
                            </details>
                        </div>
                    `;
                } else {
                    throw new Error(data.error || 'Erro desconhecido');
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h3>‚ùå Erro ao verificar disponibilidade</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // Views Tests
        async function testEfetivoDisponivel() {
            const resultDiv = document.getElementById('vw-results');
            resultDiv.innerHTML = '<p>Buscando efetivo dispon√≠vel...</p>';
            
            try {
                const response = await fetch(`${API_BASE}/vw/efetivo-disponivel`);
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h3>‚úÖ Efetivo Dispon√≠vel</h3>
                            <p><strong>Total:</strong> ${data.length} pessoas</p>
                            <details>
                                <summary>Ver dados</summary>
                                <pre>${JSON.stringify(data, null, 2)}</pre>
                            </details>
                        </div>
                    `;
                } else {
                    throw new Error(data.error || 'Erro desconhecido');
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h3>‚ùå Erro ao buscar efetivo dispon√≠vel</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function testResumoTurnos() {
            const resultDiv = document.getElementById('vw-results');
            resultDiv.innerHTML = '<p>Buscando resumo de turnos...</p>';
            
            try {
                const response = await fetch(`${API_BASE}/vw/resumo-turnos`);
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h3>‚úÖ Resumo de Turnos</h3>
                            <p><strong>Total turnos:</strong> ${data.length}</p>
                            <details>
                                <summary>Ver dados</summary>
                                <pre>${JSON.stringify(data, null, 2)}</pre>
                            </details>
                        </div>
                    `;
                } else {
                    throw new Error(data.error || 'Erro desconhecido');
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h3>‚ùå Erro ao buscar resumo de turnos</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function testLogsRecentes() {
            const resultDiv = document.getElementById('vw-results');
            resultDiv.innerHTML = '<p>Buscando logs recentes...</p>';
            
            try {
                const response = await fetch(`${API_BASE}/vw/logs-recentes`);
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h3>‚úÖ Logs Recentes</h3>
                            <p><strong>Total logs:</strong> ${data.length}</p>
                            <details>
                                <summary>Ver dados</summary>
                                <pre>${JSON.stringify(data, null, 2)}</pre>
                            </details>
                        </div>
                    `;
                } else {
                    throw new Error(data.error || 'Erro desconhecido');
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h3>‚ùå Erro ao buscar logs recentes</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function testMilitaresRestricoes() {
            const resultDiv = document.getElementById('vw-results');
            resultDiv.innerHTML = '<p>Buscando militares com restri√ß√µes...</p>';
            
            try {
                const response = await fetch(`${API_BASE}/vw/militares-restricoes`);
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h3>‚úÖ Militares com Restri√ß√µes</h3>
                            <p><strong>Total:</strong> ${data.length}</p>
                            <details>
                                <summary>Ver dados</summary>
                                <pre>${JSON.stringify(data, null, 2)}</pre>
                            </details>
                        </div>
                    `;
                } else {
                    throw new Error(data.error || 'Erro desconhecido');
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h3>‚ùå Erro ao buscar militares com restri√ß√µes</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // Integration Tests
        async function testCriarCivilComSP() {
            const resultDiv = document.getElementById('integration-results');
            resultDiv.innerHTML = '<p>Criando civil com ID via SP...</p>';
            
            try {
                const response = await fetch(`${API_BASE}/civis`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        nome_completo: 'Teste Civil SP',
                        contato: '123456789',
                        orgao_origem: 'Volunt√°rio', // Valor v√°lido do ENUM
                        motorista: false
                    })
                });
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h3>‚úÖ Civil Criado com ID via SP</h3>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    throw new Error(data.error || 'Erro desconhecido');
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h3>‚ùå Erro ao criar civil</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function testCriarAtestadoComSP() {
            const resultDiv = document.getElementById('integration-results');
            resultDiv.innerHTML = '<p>Criando atestado com ID via SP...</p>';
            
            try {
                // Primeiro buscar uma matr√≠cula v√°lida
                const militaresResponse = await fetch(`${API_BASE}/militares`);
                const militaresData = await militaresResponse.json();
                
                if (!militaresResponse.ok || militaresData.length === 0) {
                    throw new Error('Nenhum militar encontrado para criar atestado');
                }
                
                const matriculaValida = militaresData[0].matricula;
                
                // Gerar data futura para evitar conflitos
                const futureDate = new Date();
                futureDate.setDate(futureDate.getDate() + Math.floor(Math.random() * 30) + 60); // 60-90 dias no futuro
                
                const response = await fetch(`${API_BASE}/atestados`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        matricula: matriculaValida,
                        data_inicio: futureDate.toISOString().split('T')[0],
                        dias: 5,
                        motivo: 'Teste SP'
                    })
                });
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h3>‚úÖ Atestado Criado com ID via SP</h3>
                            <p><strong>Matr√≠cula usada:</strong> ${matriculaValida}</p>
                            <p><strong>Data in√≠cio:</strong> ${futureDate.toISOString().split('T')[0]}</p>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    throw new Error(data.error || 'Erro desconhecido');
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h3>‚ùå Erro ao criar atestado</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function testTriggerAuditoria() {
            const resultDiv = document.getElementById('integration-results');
            resultDiv.innerHTML = '<p>Testando trigger de auditoria...</p>';
            
            try {
                // Primeiro buscar logs antes
                const beforeResponse = await fetch(`${API_BASE}/vw/logs-recentes`);
                const beforeData = await beforeResponse.json();
                
                // Criar um turno para ativar o trigger
                const createResponse = await fetch(`${API_BASE}/turnos-com-sp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        data: new Date().toISOString().split('T')[0], 
                        periodo: 'Tarde' 
                    })
                });
                
                // Buscar logs depois
                const afterResponse = await fetch(`${API_BASE}/vw/logs-recentes`);
                const afterData = await afterResponse.json();
                
                if (createResponse.ok) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h3>‚úÖ Trigger de Auditoria Testado</h3>
                            <p><strong>Logs antes:</strong> ${beforeData.length}</p>
                            <p><strong>Logs depois:</strong> ${afterData.length}</p>
                            <p><strong>Novo log criado:</strong> ${afterData.length > beforeData.length ? 'SIM' : 'N√ÉO'}</p>
                            <details>
                                <summary>Ver logs recentes</summary>
                                <pre>${JSON.stringify(afterData.slice(0, 5), null, 2)}</pre>
                            </details>
                        </div>
                    `;
                } else {
                    throw new Error('Erro ao criar turno para teste');
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h3>‚ùå Erro ao testar trigger</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
